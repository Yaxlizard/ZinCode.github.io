<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <style>
    body,p {
        margin: 0;
        padding: 0;
    }
    #tool{
        width: 400px;
        float: left;
        border: 1px solid #ccc;
        box-shadow: 2px 2px 4px gray;
        margin-left: 20px;
        margin-top: 20px;
    }
    #paint{
        margin-right: 20px;
        margin-top: 20px;
        width: 800px;
        float: right;
    }
    #tool p{
        margin: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid gray;
        height: 50px;
    }
    #tool .control{
        position: relative;
    }
    #tool .control span{
        position: absolute;
        right: 0;
        bottom: 0;
        font-size: 14px;
        color: maroon;
    }
    #tool .control .slidebar{
        width: 180px;
    }
    </style>
</head>

<body>
    <div id='tool'>
        <p class="waterMark">
        <label>
            请输入水印名：
            <input type="text" class='waterName'>
        </label>
            <input type="button" class="btn" value='应用'>
        </p>
        <p class="control">
        拖动滑杆控制图片大小:
            <input class="slidebar" type="range" min="0.5" max="3" step='0.01' value='0.6'>
            <span>放大倍数：0.6</span>
        </p>
    </div>
    <div id='paint'>
        <canvas id='canvas' style="display: block; border: 1px solid gray"></canvas>
        <canvas id='offCanvas' style="display: none; border: 1px solid gray"></canvas>
    </div>
    <script>
    var $ = function(selector) {
        return document.querySelector(selector);
    }
    //openCanvas
var context = $('#canvas').getContext('2d');
    var w = 700,
        h = 600;
    $('#canvas').width = w;
    $('#canvas').height = h;

    //状态变量
    var isDown = false;
    var dx = 0,dy =0,iH =0,iW =0;
    //offCanvas
    var waterCanvas = $('#offCanvas');
    waterCanvas.width = 300;
    waterCanvas.height = 100;
    var wContext = waterCanvas.getContext('2d');

    var str = '';
    var txtWidth = 0;
    str = 'Zimmer';
    var scale = $('.slidebar').value;
    var scalecount = $('.control').getElementsByTagName('span')[0];

    var waterName = $('.waterName');
    var btn = $('.btn');
    btn.onclick = function(){
        if(waterName.value){
            str = waterName.value;
            waterMark();
            drawImageByScale(scale);
        }
    }
   
    $('.slidebar').onmousemove =function () {
        scale = this.value;
        scalecount.innerHTML = '放大倍数：'+this.value;
        drawImageByScale(scale);
    }
    
    $('#canvas').onmousedown = function(e){
        if(e.which ==1){    //判断是否为鼠标单击         
        isDown = true;
       e.preventDefault();
       e.stopPropagation();
        var p = getCanvasPoint(e.clientX,e.clientY);
        drawBigger(p.x,p.y,true);
        }

    }
    $('#canvas').onmousemove = function(e){
        if(isDown == true){          
        var p = getCanvasPoint(e.clientX,e.clientY);
        drawBigger(p.x,p.y,true);
        //console.log(p.x +","+p.y);
        }
    }
    $('#canvas').onmouseup = function(e){
        isDown =false;
        var p = getCanvasPoint(e.clientX,e.clientY);
        drawBigger(p.x,p.y,false);
        context.drawImage(waterCanvas, 0, 0, txtWidth, 35, w - txtWidth, h - 40, txtWidth, 35);
    }
    $('#canvas').onmouseout = function(){
        //alert('kk')
        isDown = false;
    }
    //绘制水印
    function waterMark() {
        wContext.clearRect(0,0,300,100)
        wContext.font = '30px bold Arial';
        wContext.fillStyle = 'rgba(123, 23, 78 ,0.5)';
        //wContext.textBaseLine = 'left';
        wContext.fillText('@'+str, 0, 30);
        txtWidth = wContext.measureText('@'+str).width;
        //wContext.fillRect(0,0,100,100);
    }
    waterMark();
    //图片
    var img = new Image();
    img.src = 'heben.jpg';
    img.onload = function() {
        drawImageByScale(scale);
       //console.log(img.width+','+img.height)
    }

    function drawImageByScale(scale) {
         iW = img.width * scale;
         iH = img.height * scale;
         dx = w / 2 - iW / 2;
         dy = h / 2 - iH / 2;
        context.clearRect(0, 0, w, h);
        context.drawImage(img, dx, dy, iW, iH);
        context.drawImage(waterCanvas, 0, 0, txtWidth, 35, w - txtWidth, h - 40, txtWidth, 35);
    }

    //获取鼠标在canvas画布中的坐标
    function getCanvasPoint(x,y){
        return {
            x:x-canvas.getBoundingClientRect().left,
            y:y-canvas.getBoundingClientRect().top
        }
    }
    //绘制放大镜及背景
    function drawBigger(x,y,n){
        context.clearRect(0,0,w,h);
        context.drawImage(img,dx,dy,iW,iH);
        if(n){
        drawMagnifier(x,y);
        } 
    }
    //绘制放大镜
    function drawMagnifier(x,y){
        var sx = (x-dx)/scale-100;
        var sy = (y-dy)/scale-100;
        var mx = x-200/2;
        var my = y-200/2;
        if(sx+100>0 && sy+100>0){   
        context.save();
        context.lineWidth = 5;
        context.strokeStyle= '#058';
        context.beginPath();
        context.arc(x,y,100,0,2*Math.PI);
        context.closePath();
        context.stroke();
        context.clip();       
        context.drawImage(img,sx,sy,200,200,mx,my,200,200)
        context.restore();
        }
    }
    </script>
</body>

</html>
